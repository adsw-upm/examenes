---
id: ex-2025-01
year: 2025
exam: parcial 2
tags:
 - concurrencia
---

Se quiere simular un sistema de impresión con una impresora a la que varios usuarios pueden pedir impresiones. Los usuarios pueden pedir imprimir un texto (una cadena de caracteres). La impresora debe imprimir un texto solo cuando no esté ocupada, y siempre debe dar prioridad al texto más corto. Los usuarios se modelan como hebras independientes.

Se proporciona el siguiente diagrama de clases como referencia:

![](p2/p2_ex01.png)

Se pide: 

- (a) (1 punto) Implementar la clase `Usuario`, que será una hebra con un nombre, un texto a imprimir y una referencia a la impresora, y su única labor es imprimir el texto dado en la impresora.

??? note "Mostrar solución"
    ```{.java .numberLines fontSize=/footnotesize}
    class Usuario extends Thread {
      private String nombre;
      private Impresora impresora;
      private String texto;
      public Usuario(String nombre, Impresora impresora, String texto) {
        this.nombre = nombre;
        this.impresora = impresora;
        this.texto = texto;
      }
      public void run() {
        try {
          impresora.imprimir(texto, nombre);
        } catch (InterruptedException e) {}
      }
    }
    ```


- (b) (2 puntos) Implementa una clase `Impresora` que contenga un método `imprimir` que asegure que:
    - Solo se permite imprimir un texto en cada momenton;
    - Los textos se imprimen a una velocidad de un carácter por milisegundo. Para simular la impresión, se debe usar el método `Thread.sleep(long millis)`, que puede lanzar excepciones del tipo `InterruptedException`;
    - Una vez comienza la impresión de un texto, no se podrá empezar con otro hasta haberlo terminado;
    - Si varias hebras intentan imprimir, los textos más cortos tendrán prioridad;
    - Se guarda un registro (`registro`) de todos los caracteres impresos hasta el momento por la impresora;
    - Se debe mostrar por consola un mensaje en los siguientes momentos: (1) Cuando un usuario intenta imprimir; (2) Tras imprimir cada carácter; (3) Cuando se ha terminado de imprimir un texto completo. Los mensajes deben contener el nombre de la hebra que ha realizado la acción.

??? note "Mostrar solución"
    Se acepta como válida la siguiente solución:

    ```java
    	static class Impresora {
    		private List<String> cola = new ArrayList<String>();
    		private String registro = "";
    		private boolean imprimiendo = false;

    		public synchronized void imprimir(String texto, String usuario) throws InterruptedException {
    			System.out.println(usuario + " quiere imprimir: " + texto);
                int pos = 0;
                while(pos < cola.size()) {
                    if(cola.get(i).lengt() > texto.length()) {
                        break;
                    }
                    pos++;
                }
                cola.add(pos, texto);

    			while (imprimiendo || cola.get(0) != texto) {
    				try {
    					wait();
    				} catch (InterruptedException e) {}
    			}

    			imprimiendo = true;
    			cola.remove(0);
    			System.out.println(usuario + " empieza a imprimir: " + texto);
    			int i = 0;
    			while(i < texto.length()) {
    				System.out.println(usuario + " imprime: " + texto.charAt(i));
    				registro = registro + texto.charAt(i);
    				i++;
    				Thread.sleep(10);
    			}
    			imprimiendo = false;
    			System.out.println(usuario + " termina de imprimir");
    			notifyAll();
    		}
    	}
    ```

    No obstante, la solución correcta incluiría liberar el cerrojo durante el `sleep`.
    Por ejemplo:

    ```{.java .numberLines fontSize=/footnotesize}
    class Impresora {
      private List<String> cola = new ArrayList<String>();
      private boolean imprimiendo = false;
      public String registro = "";
      public void imprimir(String texto, String usuario) throws InterruptedException {
        ponerEnCola(texto, usuario);
        intentarImprimir(texto, usuario);
        int i = 0;
        while(i < texto.length()) {
          System.out.println(usuario + " imprime: " + texto.charAt(i));
          registro = registro + texto.charAt(i);
          i++;
          Thread.sleep(10);
        }
        dejarDeImprimir(texto, usuario);
      }
      public synchronized void ponerEnCola(String texto, String usuario) {
        System.out.println(usuario + " quiere imprimir: " + texto + " [ " + texto.length() + " caracteres]");
        int pos = 0;
        while(pos < cola.size()) {
          if(cola.get(pos).length() > texto.length()) {
            break;
          }
          pos++;
        }
        cola.add(pos, texto);
      }
      public synchronized void intentarImprimir(String texto, String usuario) {
        while (imprimiendo || !cola.get(0).equals(texto)) {
          try {
            wait();
          } catch (InterruptedException e) {}
        }
        cola.remove(0);
        imprimiendo = true;
        System.out.println(usuario + " empieza a imprimir: " + texto);
      }
      public synchronized void dejarDeImprimir(String texto, String usuario) {
        System.out.println(usuario + " termina de imprimir");
        imprimiendo = false;
        notifyAll();
      }
    }
    ```


- (c) (1 punto) Implementa el método `main` para que sirva de prueba rápida la implementación (`smoketest`). Se deben crear al menos 4 usuarios que impriman textos diferentes en la misma impresora, y mostrar un texto al finalizar todas las impresiones.

??? note "Mostrar solución"
    ```{.java .numberLines fontSize=/footnotesize}
    public static void main(String[] args) throws InterruptedException {
    	Impresora impresora = new Impresora();
    	String[] textos = { "hola\n", "buenos días\n", "adiós\n", "sí\n" };
    	Usuario[] usuarios = new Usuario[textos.length];
    	for (int i = 0; i < textos.length; i++) {
    		usuarios[i] = new Usuario("Usuario " + (char)('A' + i), impresora, textos[i]);
    	}
    	for (Usuario u : usuarios) {
    		u.start();
    	}
    	for (Usuario u : usuarios) {
    		try {
    			u.join();
    		} catch (InterruptedException e) {}
    	}
    	System.out.println("Todos los trabajos han terminado. Texto final: " + impresora.registro());
    }
    ```


- (d) (1 punto) Explica qué modificaciones se podrían realizar en el código para que una impresora permita imprimir a 2 usuarios a la vez.

??? note "Mostrar solución"
    Habría que cambiar el flag de imprimiendo para que fuera un entero con el número de usuarios imprimiendo en ese momento. También habría que sacar el `sleep` de la zona crítica. De lo contrario, mientras una hebra está imprimiendo el resto quedarían bloqueadas.
