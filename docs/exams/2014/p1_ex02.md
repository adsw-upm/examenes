---
id: ex-2014-02
year: 2014
exam: parcial 1
tags:
 - monitores
---
Sea un cruce de calles por el que circulan coches de oeste a este y de norte a sur. Para regular el tráfico hay dos semáforos, uno en la entrada oeste y otro en la entrada norte, y dos sensores, que se activan cuando llega un coche a cada una de las entradas. También hay sensores que indican la salida del cruce.

Se desea desarrollar un monitor en Java que simule la gestión de los semáforos con las siguientes forma:

* Los coches se modelan como hebras (threads) que invocan un método `llegaNorte()` o `llegaOeste()` cuando llegan al cruce.

* Si el semáforo correspondiente está en verde, el coche pasa inmediatamente.

* Si el semáforo está en rojo, el coche espera hasta que se ponga en verde.

* Los coches tardan un cierto tiempo en atravesar el cruce. Al salir invocan el método `sale()` del monitor.

* Una hebra de control llama periódicamente al método `cambiaSemáforos()` para cambiar la configuración de los semáforos.

El monitor responde al siguiente esquema:

```java
class GestorCruce {
    ...
    
    // Lo invoca un coche que llega por el norte
    llegaNorte() { ... }
    
    // Lo invoca un coche que llega por el oeste
    llegaOeste() { ... }
    
    // Lo invoca un coche que sale del cruce
    sale() { ... }
    
    // Lo invoca la hebra de control
    cambiaSemáforos() { ... }
...
}
```

- (a) Se pide (5 puntos)  Desarrollar el código completo del monitor , justificando la respuesta. Se valorará especialmente el razonamiento sobre el diseño del monitor.

??? note ""
    En el sistema existen dos tipos de hebras que representan, respectivamente, el comportamiento de los coches y el control de los semáforos. Estas hebras invocan los métodos del monitor para actualizar el estado del cruce y sincronizarse.
    
    El monitor almacena el estado del cruce mediante atributos privados. En este caso se identifican los siguientes:
    
    * Estado de los semáforos: puede representarse mediante un valor booleano. Basta con una sola variable, ya que cuando un semáforo está en verde, el otro está en rojo.
    * Número de coches en el cruce: se representa mediante un booleano, ya que solo se permite un coche a la vez.
    
    Nótese que no es necesario representar el número de coches que esperan, ni el tiempo que transcurre entre la entrada y la un salida de un coche. Este último aspecto se debe modelar en la clase que representa elcomportamiento de los coches. Tampoco hay que modelar aquí el tiempo que transcurre entre los cambios de los semáforos, que corresponde a la hebra de control.
    
    En cuanto a la implementación del gestor, debe realizarse como un monitor, por lo que todos los atributos dedatos deber ser privados, y todos los métodos públicos (excepto los constructores) deben estar sincronizados.
    
    Una posible implementación es la siguiente:
    
    ```java
    public class GestorCruce {
    
        // true indica semáforo norte en verde (oeste en rojo)
        private boolean norteVerde = true;
    
        // Indica si hay un coche pasando por el cruce
        private boolean cochePasando = false;
    
        // Invocado por un coche que llega desde el norte
        public synchronized void entraNorte() throws InterruptedException {
            while (!norteVerde || cochePasando)
                wait();
            cochePasando = true;
        }
    
        // Invocado por un coche que llega desde el oeste
        public synchronized void entraOeste() throws InterruptedException {
            while (norteVerde || cochePasando)
                wait();
            cochePasando = true;
        }
    
        // Invocado por un coche que sale del cruce
        public synchronized void sale() {
            cochePasando = false;
            notifyAll();
        }
    
        // Invocado por la hebra de control de los semáforos
        public synchronized void cambiaSemaforos() {
            norteVerde = !norteVerde;
            notifyAll();
        }
    }
    ```
    
    Obsérvese que si cambian los semáforos cuando hay un coche en el cruce, no puede entrar ningún otro coche en la nueva orientación hasta que el coche que está en el cruce salga, ya que `cochePasando` será `true`.
    
    Los métodos `entraNorte` y `entraOeste` propagan `IntrruptedException`. Una alternativa sería maneja la interrupción en estos métodos con un bloque try-catch.
