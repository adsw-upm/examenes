---
id: ex-2017-01
year: 2017
exam: parcial 2
tags:
 - hebras
---

Se quiere desarrollar un sistema compuesto de dos conjuntos de hebras. Un conjunto de hebras (editoras) producen contenidos sobre un tema y los envían a un monitor, Gestor. Otro conjunto de hebras (suscriptoras) reciben los contenidos publicados sobre los temas a los que se suscriben. Las hebras editoras y suscriptoras utilizan los siguientes métodos del gestor para sincronizarse:

```java
public class Gestor {
    ...
    public ... void enviarContenido (Tema unTema, Contenido unContenido) {...}
    public ... Contenido recibirContenido (Tema unTema) {...}
}
```

Se proporcionan las siguientes clases auxiliares que no hay que implementar:

```java
public class Contenido {
    private String contenido;

    public Contenido(String contenido) {
        this.contenido = contenido;
    }

    // ...
}

public enum Tema {
    NACIONAL, INTERNACIONAL, CULTURA, DEPORTE;

    public static Tema random() {
        // ...
        return null;
    }
}

public class Nap {

    /**
     * Duerme un periodo aleatorio entre los limites indicados.
     *
     * @param min milisegundos minimos.
     * @param max milisegundos maximos.
     */
    public static void random(int min, int max) {
        // ...
    }
}
```

- (a) (1 punto) Escriba el código de una clase que defina hebras suscriptoras. Cada hebra ejecuta un bucle N_VECES (una constante). En cada ciclo genera un tema aleatorio (ver más abajo) e invoca el gestor para recibir mensajes de ese tema. Al recibir un mensaje, invoca un método privado de la clase, procesarContenido(Contenido c), que no hay que implementar. Finalmente, se bloquea durante un tiempo aleatorio (puede usar el método nap.random()).

??? note "Mostrar solución"
    ```java
    public class Suscriptora extends Thread {
        private Gestor gestor;
        private int id;
        private final int N_VECES = …;

        public Suscriptora(Gestor gestor, int id) {
            this.gestor = gestor;
            this.id = id;
        }

        private void procesarContenido(Contenido unContenido) {
            // ...
        }

        @Override
        public void run() {
            Tema unTema;
            Contenido unContenido;

            for (int i = 0; i < N_VECES; i++) {
                unTema = Tema.random();
                unContenido = gestor.recibirContenido(unTema);
                if (unContenido != null)
                    procesarContenido(unContenido);

                Nap.random(100, 500); // por ejemplo
            }
        }
    }
    ```


- (b) (1 punto) Escriba un esquema del código de una clase para definir hebras editoras. En este caso, sólo hay que implementar el constructor. Su contenido sería similar a la anterior.

??? note "Mostrar solución"
    ```java
    public class Editora extends Thread {
        private Gestor gestor;
        private int id;
        private final int N_VECES = 5;

        public Editora(Gestor gestor, int id) {
            this.gestor = gestor;
            this.id = id;
        }

        @Override
        public void run() {
            // ...
        }
    }
    ```


- (c) (2 puntos) Escriba el código de una clase con un programa principal (main) que arranque N_EDITORAS hebras editoras y N_SUSCRIPTORAS hebras suscriptoras, y cree el gestor de contenidos.

??? note "Mostrar solución"
    ```java
    public class PruebaGestor {

        public static void main(String[] args) {
            final int N_EDITORAS = 10;
            final int N_SUSCRIPTORAS = 10;

            Gestor gestor = new Gestor();

            for (int i = 0; i < N_EDITORAS; i++) {
                new Editora(gestor, i).start();
            }

            for (int i = 0; i < N_SUSCRIPTORAS; i++) {
                new Suscriptora(gestor, i).start();
            }
        }
    }
   ```


- (d) (4 puntos) Completar la clase Gestor de forma que se comporte como un monitor, con lo necesario para sincronizar las hebras de las dos clases citadas. La implementación de los métodos del gestor debe cumplir la siguiente especificación:

```java
... void enviarContenido(Contenido unContenido, Tema unTema)
```

Cuando una hebra editora invoca este método para publicar un contenido, se debe reanudar la ejecución de todas las hebras suscriptoras que estuvieran esperando este tema. El contenido debe estar disponible para las suscriptoras hasta que una hebra editora envíe el siguiente contenido.

```java
... Contenido recibirContenido (Tema unTema)
```

Cuando una hebra suscriptora invoca este método, recibe el último contenido publicado si su tema coincide con el solicitado. Si el último contenido es de otro tema, la hebra se bloquea hasta que una hebra editora envíe un contenido del tema solicitado.

??? note "Mostrar solución"
    ```java
    public class Gestor {
        
        private Contenido contenido;
        private Tema tema;
    
        public synchronized void enviarContenido(Tema unTema, Contenido unContenido) {
            if (unContenido == null) return;
            contenido = unContenido;
            tema = unTema;
            notifyAll();
        }
    
        public synchronized Contenido recibirContenido(Tema unTema) {
            if (unTema == null) return null;
            while (unTema != tema) {
                try {
                    wait();
                } catch (InterruptedException e) {
                    System.out.println("Interrupción no esperada");
                }
                return contenido;
            }
            return contenido;
        }
    }
    ```